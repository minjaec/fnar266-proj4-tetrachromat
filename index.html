<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>tetrachromat</title>
</head>

<style>
    @import url('https://fonts.googleapis.com/css?family=Muli:300,400,700');

    html,
    body {
        width: 100%;
        height: 100%;
        margin: 0px;
        border: 0;
        overflow: hidden;
        /*  Disable scrollbars */
        display: block;
        /* No floating content on sides */
        font-family: 'Muli', sans-serif;
    }
</style>

<body onload="resizeCanvas()">
    <canvas id="bgcanvas"></canvas>
    <script src="js/color-thief.min.js"></script>
    <script>
        var c = document.querySelector("#bgcanvas");
        var ctx = c.getContext('2d');
        window.addEventListener('resize', resizeCanvas, false);
        c.addEventListener('mouseenter', mousemove, false);
        c.addEventListener('mousemove', mousemove, false);
        c.addEventListener('click', onclick, false);
        var maxDist = 0;
        var gradientsShuffled = false;
        var nColors = 4;

        function resizeCanvas() {
            c.width = window.innerWidth;
            c.height = window.innerHeight;
            maxDist = Math.max(c.width, c.height);
            G.forEach(updateGradientParams);
            c.dispatchEvent(new MouseEvent('mousemove'));
        };

        function onclick(event) {
            showImage('SOTA_P_2011_005.002.O.jpg');
            gradientsShuffled = false;
            dt = 0;
            G.forEach(updateGradientParams);
        };

        var mouse = { x: 0, y: 0 }; //mouse.x, mouse.y
        var g1 = { x: 0, y: 0, dx: 0, dy: 0, r: 0, sx: 0, sy: 0, trig: null };
        var g2 = { x: 0, y: 0, dx: 0, dy: 0, r: 0, sx: 0, sy: 0, trig: null };
        var g3 = { x: 0, y: 0, dx: 0, dy: 0, r: 0, sx: 0, sy: 0, trig: null };
        var g4 = { x: 0, y: 0, dx: 0, dy: 0, r: 0, sx: 0, sy: 0, trig: null };
        var G = [g1, g2, g3, g4];

        function mousemove(event) {
            mouse.x = event.clientX;
            mouse.y = event.clientY;
        };

        var inertiaFactor = 20;
        var fillOrder = [];

        function followMouse(g) {
            //1. find distance X , distance Y
            var distX = mouse.x - g.x + g.dx + g.sx * g.trig(dt) * g.r;
            var distY = mouse.y - g.y + g.dy + g.sy * g.trig(dt) * g.r;
            //Easing motion
            g.x += distX / inertiaFactor;
            g.y += distY / inertiaFactor;
        };

        function randomSign() {
            return Math.sign(0.5 - Math.random());
        };

        function randomTrig() {
            if (Math.random() < 0.5) {
                return Math.sin;
            } else {
                return Math.cos;
            };
        };
        function randomOffset(center, alpha) {
            return center + alpha * 2 * (0.5 - Math.random());
        };

        var movementCoefficient = 0.2;

        function updateGradientParams(g) {
            g.dx = randomOffset(0, maxDist / 4);
            g.dy = randomOffset(0, maxDist / 4);
            g.r = randomOffset(maxDist, maxDist / 3);
            g.sx = randomSign() * movementCoefficient;
            g.sy = randomSign() * movementCoefficient;
            g.trig = randomTrig();
            g.trig = randomTrig();
        };

        var imageDisplayed = false;
        var img;

        function showImage(fileName) {
            img = new Image;
            img.onload = function () {
                var colorthief = new ColorThief();
                var colorthief_palette = colorthief.getPalette(img, 4);
                /* Turn color-thief palette to nearest-color-compatible palette. */
                for (var i = 0; i < colorthief_palette.length; i++) {
                    var r = colorthief_palette[i][0];
                    var g = colorthief_palette[i][1];
                    var b = colorthief_palette[i][2];
                    imagePalette.push(['rgba(' + r + ',' + g + ',' + b + ',' + 1 + ')', 'rgba(' + r + ',' + g + ',' + b + ',' + 0 + ')']);
                }
                imageDisplayed = true;
            }
            img.src = 'images/' + fileName;
        };

        //FOR WHEN nColors = 4
        var defaultColors = [['rgba(1,159,98,1)', 'rgba(1,159,98,0)'],
        ['rgba(255,1,136,1)', 'rgba(255,1,136,0)'],
        ['rgba(0,201,255,1)', 'rgba(0,201,255,0)'],
        ['rgba(228,199,0,1)', 'rgba(228,199,0,0)']];

        var imagePalette = [];

        function getColor(index) {
            //index  0 to 3
            if (imageDisplayed) {
                return imagePalette[index];
            } else {
                imagePalette = [];
                return defaultColors[index];
            }
        };

        var dt = 0;
        setInterval(draw, 30)

        function draw() {
            ctx.clearRect(0, 0, c.width, c.height);
            //context.createRadialGradient(x0,y0,r0,x1,y1,r1);
            G.forEach(followMouse);
            dt += 0.03;
            var gradients = [];

            var i;
            for (i = 0; i < nColors; i++) {
                var radgrad = ctx.createRadialGradient(G[i].x, G[i].y, 1, G[i].x, G[i].y, G[i].r);
                radgrad.addColorStop(0, getColor(i)[0]);
                radgrad.addColorStop(1, getColor(i)[1]);
                gradients.push(radgrad)
            };

            if (!gradientsShuffled) {
                var i;
                for (i = 0; i < gradients.length; i++) {
                    fillOrder[i] = i;
                }
                shuffleArray(fillOrder);
                gradientsShuffled = true;
            }

            fillOrder.forEach(function (item) {
                ctx.fillStyle = gradients[item];
                ctx.fillRect(0, 0, c.width, c.height);
            })

            renderContent();
            if(imageDisplayed) ctx.drawImage(img, 200, 200, 200, 200);
        };

        function renderContent() {
            //render page content
            ctx.font = getFont(300, 1, 48, 72);
            ctx.textAlign = "center";
            ctx.fillText("tetrachromat", c.width / 2, c.height / 2);
            ctx.font = getFont(300, 0.5, 24, 36);
            ctx.fillText("tauba auerbach", c.width / 2, c.height / 2 + result * 1.2);
            ctx.font = getFont(700, 0.2, 18, 24);
            ctx.fillText("BERGEN KUNSTHALL", c.width / 2, c.height - result);
        }

        var fontBase = 1000, fontSize = 70, result;

        function getFont(weight, scaleFactor, minSize, maxSize) {
            var ratio = fontSize / fontBase;   // calc ratio
            var size = c.width * ratio * scaleFactor;   // get font size based on current width
            result = size.clamp(minSize, maxSize);
            return (weight) + ' ' + (result | 0) + 'px Muli'; // set font
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        };

        /**
         * Returns a number whose value is limited to the given range.
         *
         * Example: limit the output of this computation to between 0 and 255
         * (x * 255).clamp(0, 255)
         *
         * @param {Number} min The lower boundary of the output range
         * @param {Number} max The upper boundary of the output range
         * @returns A number in the range [min, max]
         * @type Number
         */
        Number.prototype.clamp = function (min, max) {
            return Math.min(Math.max(this, min), max);
        };

    </script>
</body>

</html>